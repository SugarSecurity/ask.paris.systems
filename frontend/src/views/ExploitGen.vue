<template>
  <div>
    <Navbar title="Exploit Generator" />

    <div class="max-w-6xl mx-auto pt-6 pb-32 px-6 flex flex-col gap-12">
      <!-- Account Overview -->
      <div>
        <div class="mb-2 text-xl font-medium">Generate Exploit for CVE</div>
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl grid grid-cols-1 flex-grow overflow-hidden">
    
          <div class="mb-4 grid md:grid-cols-3 gap-4">
            <form @submit.prevent="startJob">
              <input placeholder="CVE-2023-12345" class="cve-input" type="text" id="cve-input" />
              
              <select id="language" name="language">
                <option value="python">Python</option>
                <option value="javascript">JavaScript</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="cs">C#</option>
                <option value="golang">GoLang</option>
              </select>

              <button type="submit" class="submit-button">
                Generate Exploit
              </button>
            </form>
          </div>
        </div>

        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl grid grid-cols-1 flex-grow overflow-hidden">
          <div class="mb-2 grid md:grid-cols-2 gap-1">
            <p>Exploit Code:</p>
            <br />

            <spinner v-if="isLoading"/>
            <div v-if="isLoading" class="countdown">
              {{ countdown }}
            </div>

            <div v-else>
              <code >
                {{ exploit_code }}
              </code>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Navbar from '@/components/Navigation/Navbar.vue';
import Spinner from '@/components/Spinner.vue';
import { useToast } from "vue-toastification";
import axios from 'axios';

export default {
  components: {
    Navbar
  },
  data() {
    return {
      isLoading: false,
      countdown: 120,
      exploit_code: "",
      job_id: "",
      timer: null
    }
  },
  setup() {
    const toast = useToast();
    return { toast }
  },
  mounted() {
    window.tippy("#copy-button", { content: 'Copy', arrow: window.tippy.roundArrow, delay: [null, 75], theme: 'ss-tooltip', placement: 'bottom', animation: 'shift-toward' });
  },
  async created() {
  },
  methods: {
    startCountdown() {
      const timer = setInterval(() => {
        this.countdown -= 1;
        if (this.countdown === 0) {
          clearInterval(timer);
          this.isLoading = false;
        } else if (this.countdown > 0) {
            this.isLoading = true;
          }
      }, 1000);
    },
    async checkJob(job_id) {
      try {
        const job_results = await axios.get(`https://assets.sugarsecurity.com/paris_results/${job_id}`);
        console.log(job_results);

        if (job_results.status == 200) {
          this.isLoading = false;
          this.countdown = 0;
          clearInterval(this.timer);
          this.exploit_code = job_results.data;
          return;
        } else {
          setTimeout(() => this.checkJob(job_id), 3000);
        }
      } catch (error) {
        console.log(error);
        if (this.countdown > 3) {
          setTimeout(() => this.checkJob(job_id), 3000);
        } else {
          this.toast("Error generating exploit. Please try again later.");
          this.isLoading = false;
        }
      }
    },
    async startJob() {
      this.isLoading = true;
      this.startCountdown();
      try {
        const api_endpoint = 'https://tejold815d.execute-api.us-east-1.amazonaws.com/dev/generate';
        const api_response = await axios.post(api_endpoint, {
          target_cve: document.getElementById("cve-input").value,
          language: document.getElementById("language").value
        });

        if (api_response.status !== 200) {
          this.toast("Error generating exploit. Please try again later.")
          this.isLoading = false;
          return;
        } else {
          this.toast("Started Exploit Code Generation...");
        }
        console.log(api_response);
        this.job_id = api_response.data.job_id;
        this.checkJob(this.job_id);
      } catch (error) {
        console.log(error);
      }
    },
    copyTextToClipboard(textToCopy, title) {
      navigator.clipboard.writeText(textToCopy);
      this.toast(`${title} copied!`)
    }
  }
}
</script>

<style scoped>

.countdown {
  /* Add your styles here */
  font-size: 18px;
  font-weight: bold;
  margin-top: 10px;
}

.settings-row {
  @apply hover:bg-pink-300/20  py-4 px-6 transition duration-150 ease-in-out flex justify-between items-center;
}

.dark .settings-row {
  @apply hover:bg-pink-500/20;
}

.action-button {
  opacity: 0;
  transform: scale(0.7);
  @apply bg-pink-500 hover:bg-pink-600 px-3 py-1.5 rounded-full transition ease-out duration-150;
}

.settings-row:hover .action-button {
  transform: scale(1);
  opacity: 1;
}

.billing-table {
  @apply w-full bg-white border border-slate-200 rounded-xl flex-grow overflow-hidden
}

.dark .billing-table {
  @apply bg-slate-800;
}

.billing-table th {
  font-family: 'Satoshi-Medium';
  @apply text-left py-3 px-6 border-b border-slate-100;
}

.billing-table td {
  @apply text-left py-3 px-6 border-b border-slate-100;
}

.dark .billing-table th,
.dark .billing-table td {
  border-color: rgb(51 65 85);
}

.billing-table td:first-child {
  width: 70%;
}

.billing-table th:last-child {
  @apply text-right;
}

.billing-table td:last-child {
  @apply text-right;
}
</style>